<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- JavaScript Libraries -->
<script src="~/dashmin-1.0.0/lib/chart/chart.min.js"></script>
<script src="~/dashmin-1.0.0/lib/easing/easing.min.js"></script>
<script src="~/dashmin-1.0.0/lib/waypoints/waypoints.min.js"></script>
<script src="~/dashmin-1.0.0/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="~/dashmin-1.0.0/lib/tempusdominus/js/moment.min.js"></script>
<script src="~/dashmin-1.0.0/lib/tempusdominus/js/moment-timezone.min.js"></script>
<script src="~/dashmin-1.0.0/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
<script src="~/js/site.js"></script>
<!-- Template Javascript -->
<script src="~/dashmin-1.0.0/js/main.js"></script>

<script>
    $(document).ready(function () {
        var map = L.map('map').setView([39.9334, 32.8597], 6);
        var marker;
        var currentPolygon;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        function updateMarker(lat, lng) {
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                marker.on('dragend', function (e) {
                    var coord = e.target.getLatLng();
                    $('#lat').val(coord.lat);
                    $('#lng').val(coord.lng);
                });
            }
            $('#lat').val(lat);
            $('#lng').val(lng);
        }

        map.on('click', function (e) {
            updateMarker(e.latlng.lat, e.latlng.lng);
        });

        function searchLocation() {
            var city = $('#CityId option:selected').val() ? $('#CityId option:selected').text() : '';
            var district = $('#DistrictId option:selected').val() ? $('#DistrictId option:selected').text() : '';
            var neighborhood = $('#NeighborhoodId option:selected').val() ? $('#NeighborhoodId option:selected').text() : '';

            var addressParts = [];

            if (neighborhood) {
                // --- DÜZELTME BURADA BAŞLIYOR ---

                // 1. Önce sondaki boşlukları temizle
                neighborhood = neighborhood.trim();

                // 2. " MAH." veya " MAH" (büyük/küçük harf duyarsız) ile bitiyorsa, bunu sil.
                // Örnek: "KÖŞK MAH." -> "KÖŞK" kalır.
                neighborhood = neighborhood.replace(/(\s)MAH\.?$/i, '');

                // 3. Kelimenin içinde "Mahallesi" geçmiyorsa sonuna ekle.
                // Örnek: "KÖŞK" -> "KÖŞK Mahallesi" olur.
                if (neighborhood.toLowerCase().indexOf("mahallesi") === -1) {
                    neighborhood += " Mahallesi";
                }

                // --- DÜZELTME BİTTİ ---

                addressParts.push(neighborhood);
            }

            if (district) addressParts.push(district);
            if (city) addressParts.push(city);

            if (addressParts.length === 0) return;

            var query = addressParts.join(', ') + ', Turkey';

            // Kontrol için konsola yazdırıyoruz: Artık "KÖŞK Mahallesi, Keçiören..." yazmalı.
            console.log("Aranan Konum (Düzeltilmiş):", query);

            var url = 'https://nominatim.openstreetmap.org/search?format=json&polygon_geojson=1&q=' + encodeURIComponent(query);

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var result = data.find(x => x.class === "boundary") || data[0];
                        var lat = result.lat;
                        var lon = result.lon;

                        updateMarker(lat, lon);

                        if (currentPolygon) map.removeLayer(currentPolygon);

                        if (result.geojson && (result.geojson.type === "Polygon" || result.geojson.type === "MultiPolygon")) {
                            currentPolygon = L.geoJSON(result.geojson, {
                                style: { color: "red", weight: 2, fillColor: "red", fillOpacity: 0.1 }
                            }).addTo(map);

                            if (neighborhood || district) {
                                map.fitBounds(currentPolygon.getBounds());
                            } else {
                                map.setView([lat, lon], 8);
                            }
                        } else {
                            var zoomLevel = neighborhood ? 16 : (district ? 12 : 8);
                            map.setView([lat, lon], zoomLevel);
                        }
                    } else {
                        console.log("Konum bulunamadı. Sorgu:", query);
                    }
                })
                .catch(err => console.error("Hata:", err));
        }

        // --- DROPDOWN KISIMLARI AYNEN KALIYOR ---
        $.getJSON("/Location/GetCities", function (data) {
            $.each(data, function (index, item) {
                $("#CityId").append($('<option>', { value: item.cityID, text: item.cityName }));
            });
        });

        $('#CityId').change(function () {
            var selectedId = $(this).val();
            $('#DistrictId').empty().append('<option value="">İlçe Seçiniz</option>');
            $('#SemtId').empty().append('<option value="">Semt Seçiniz</option>');
            $('#NeighborhoodId').empty().append('<option value="">Mahalle Seçiniz</option>');

            if (selectedId) {
                $.getJSON("/Location/GetDistricts", { id: selectedId }, function (data) {
                    $.each(data, function (index, item) {
                        $("#DistrictId").append($('<option>', { value: item.districtID, text: item.districtName }));
                    });
                });
                searchLocation();
            }
        });

        $('#DistrictId').change(function () {
            var selectedId = $(this).val();
            $('#SemtId').empty().append('<option value="">Semt Seçiniz</option>');
            $('#NeighborhoodId').empty().append('<option value="">Mahalle Seçiniz</option>');

            if (selectedId) {
                $.getJSON("/Location/GetSemts", { id: selectedId }, function (data) {
                    $.each(data, function (index, item) {
                        $("#SemtId").append($('<option>', { value: item.semtID, text: item.semtName }));
                    });
                });
                searchLocation();
            }
        });

        $('#SemtId').change(function () {
            var selectedId = $(this).val();
            $('#NeighborhoodId').empty().append('<option value="">Mahalle Seçiniz</option>');
            if (selectedId) {
                $.getJSON("/Location/GetNeighborhoods", { id: selectedId }, function (data) {
                    $.each(data, function (index, item) {
                        $("#NeighborhoodId").append($('<option>', { value: item.neighborhoodID, text: item.neighborhoodName }));
                    });
                });
            }
        });

        $('#NeighborhoodId').change(function () {
            searchLocation();
        });
    });
</script>